\documentclass[10pt,fleqn,twoside]{article}
\usepackage{palatino}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{amsthm}
\usepackage{eucal}
\usepackage{graphicx}
\usepackage{color}

\usepackage[round]{natbib}
\bibliographystyle{abbrvnat}
%\usepackage[german]{babel}
%\usepackage[utf8]{inputenc}

%\graphicspath{{pics/}{figs/}{~/write/tex/pics/}{~/write/tex/figs/}{~/teaching/pics-all/}}
\usepackage{geometry}
\geometry{a4paper,hdivide={35mm,*,35mm},vdivide={35mm,*,35mm}}
\renewcommand{\baselinestretch}{1.1}

\newenvironment{items}{
\par\small
\begin{list}{--}{\leftmargin4ex \rightmargin0ex \labelsep1ex \labelwidth2ex
\topsep0pt \parsep0ex \itemsep3pt}
}{
\end{list}
}

\input{../../../../doc/PRADA/macros}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

 
\title{PR2 Controller -- Gravity Compensation Callibration}
\author{Danny}
\begin{document}
\maketitle
\section{Problem Definition}
The PR2 controller greatly relies on a precise dynamics model. Especially the gravity compensation is crucial for compliant, yet accurate control performance. Unfortunately, the counterbalance system of the PR2 generates joint state dependent forces that are \emph{not} part of the usual analytic dynamics model. Therefore, the goal is to use machine learning to obtain a better dynamics model. Generally, the dynamics of a (rigid) robot manipulator are given by
\begin{align}
	M(q)\ddot{q}+C(q,\dot{q})\dot{q}+G(q) = u.
\end{align}
The term $G(q)$ is the force generated by gravity. More compactly, this reads as
\begin{align}
	M\ddot{q}+F(q,\dot{q}) = u.
\end{align}
for $F(q,\dot{q}) = C(q,\dot{q})\dot{q}+G(q)$.

Given the state $q,\dot{q}$, the Featherstone algorithm (\texttt{world.equationOfMotion(M,F);}) provides a method to calculate $M$ and $F$ efficiently. Whereas $M$ and the $C$ in $F$ are considered to be precise (they are based on CAD-data), the $G(q)$ is completely wrong, as it does not contain the springs of the PR2. Usually, it is even turned off. Therefore, instead of learning the whole dynamics model, we are only interested in the gravity compensation. As a consequence, we think that the static case $\ddot{q},\dot{q} = 0$ is sufficient. If the robot is at a static equilibrium,
\begin{align}
	F(q,0) = u
\end{align}
must hold true. As this is certainly not the case in the presence of the springs, the goal is to learn the \emph{residual} $\widehat{F}(q)$ such that
\begin{align}
	F(q,0) + \widehat{F}(q) = u.
\end{align}
This is to learn which motor signals $u=\widehat{F}(q)$ are necessary to hold the robot at every joint state $q$. The necessary motor commands $u$ can be obtained quite easily with a P(I)D controller that holds the robot at a specific $q$.
\section{Method}
Collect data $D=\left\{q^{(i)},u^{(i)}\right\}_{i=1}^w$ of random poses $q^{(i)}\in\mathbb{R}^n$ of the robot. The $u^{(i)}\in\mathbb{R}^n$ are the commanded torques to the motors, which were calculated by the realtime P(I)D controller. Before reading the $u^{(i)}$, it should be waited for a few seconds in order to ensure that the controller has been converged. Averaging the $u^{(i)}$ is also reasonable. 
\subsection{Pose Generation}
\subsection{Model}
After having sampled the data, the residual $\widehat{F}(q)$ is considered to be linear in some features
\begin{align}
	\widehat{F}(q) = \phi(q)^T\beta.
\end{align}
The optimal $\beta$ is calculated with standard ridge regression regularization. 
\section{Features}
Of course, one could use Gaussian kernels (or RBFs in the feature view case). However, we think that in the 7 dimensional joint space the generalization capabilities for unseen configurations are considered to be limited. In addition, it should be possible, in principle, to express the counter balance system analytically. Therefore, finding features that could be parts of the analytic expressions of the gravity compensations seems to be more reasonable. Possible features are
\begin{itemize}
\item $1$.
\item $q$.
\item $q^2$ (component wise).
\item $q^p$ (component wise) for some $p\in\mathbb{N}$.
\item $\sin/\cos(q)$ (component wise).
\item $\sin/\cos\left(\sum_{i\in T}q_i\right)$ for some index set $T$.
\item $J(q)q$. Jacobian $J$ of something interesting, for example the Jacobian of the center of mass of a link, multiplied with the joint state $q$. Maybe evaluated only at a subset $T$ of joint states.
\item $F(q,0)$ analytic model of the gravity compensation. Then the method described here will learn the influence of the springs only. 
\end{itemize}
\end{document}
